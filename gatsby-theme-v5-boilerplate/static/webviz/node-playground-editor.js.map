{"version":3,"sources":["/home/mgohlke/webviz/packages/webviz-core/src/panels/NodePlayground/Editor.js","/home/mgohlke/webviz/packages/webviz-core/src/panels/NodePlayground/prettier.js"],"names":["codeEditorService","StaticServices","get","gotoSelection","editor","selection","endLineNumber","endColumn","setSelection","revealRangeInCenter","pos","lineNumber","startLineNumber","column","startColumn","setPosition","revealPositionInCenter","projectConfig","getNodeProjectConfig","autoFormatOnSave","script","setScriptCode","vimMode","resizeKey","save","setScriptOverride","rosLib","editorRef","React","useRef","vimModeRef","autoFormatOnSaveRef","current","useEffect","initVimMode","dispose","monacoApi","languages","typescript","typescriptDefaults","addExtraLib","fileName","doOpenEditor","useCallback","input","requestedModel","getModel","resource","uri","path","filePath","code","getValue","readOnly","options","undefined","Uri","parse","model","createModel","setValue","setModel","useMemo","wordWrap","minimap","enabled","willMount","monaco","defineTheme","vsWebvizTheme","setEagerModelSync","javascriptDefaults","registerDocumentFormattingEditProvider","provideDocumentFormattingEdits","async","range","getFullModelRange","text","e","setDiagnosticsOptions","noSyntaxValidation","noSemanticValidation","declarations","forEach","lib","sourceCode","utilityFiles","sourceFile","updateOptions","tabSize","saveCode","getAction","run","didMount","addAction","id","label","keybindings","KeyMod","CtrlCmd","KeyCode","KEY_S","onChange","srcCode","key","language","theme","editorWillMount","editorDidMount","prettier","parserPlugin","format","parser","plugins"],"mappings":";sMAQA,iEACA,8CACA,qCACA,sDACA,qEAEA,4DAEA,4DACA,yCACA,oE,sdAEA,MAEMA,kBAAoBC,mCAAeD,kBAAkBE,MAgBrDC,cAAgB,CAACC,OAA0BC,aAC/C,GAAIA,UACF,GAAIA,UAAUC,eAAiBD,UAAUE,UAEvCH,OAAOI,aAAaH,WACpBD,OAAOK,oBAAoBJ,UAAW,OACjC,CAEL,MAAMK,IAAM,CACVC,WAAYN,UAAUO,gBACtBC,OAAQR,UAAUS,aAEpBV,OAAOW,YAAYL,KACnBN,OAAOY,uBAAuBN,IAAK,KAKnCO,eAAgB,iBAAAC,wB,aACP,EACbC,kCACAC,cACAC,4BACAC,gBACAC,oBACAC,UACAC,oCACAC,kBAEA,MAAMC,UAAYC,MAAMC,OAAyB,MAC3CC,WAAaF,MAAMC,OAAO,MAC1BE,oBAAsBH,MAAMC,OAAOV,kBACzCY,oBAAoBC,QAAUb,iBAE9BS,MAAMK,UAAU,KACVN,UAAUK,UACRV,QACFQ,WAAWE,SAAU,aAAAE,aAAYP,UAAUK,SAClCF,WAAWE,SAEpBF,WAAWE,QAAQG,YAGtB,CAACb,UAEJM,MAAMK,UAAU,KACdG,UAAUC,UAAUC,WAAWC,mBAAmBC,YAChDd,OACC,+BAA8BT,cAAcS,OAAOe,WAErD,CAACf,SAUJ1B,kBAAkB0C,aAAed,MAAMe,YAAY,CAACvC,OAAQwC,SAC1D,MAAMC,eAAiBT,UAAUhC,OAAO0C,SAASF,MAAMG,UACvD,OAAKF,eAMDA,eAAeG,IAAIC,QAAS7B,kBAA5B,EAA4BA,OAAQ8B,WAKxCzB,kBAAkB,CAChByB,SAAUL,eAAeG,IAAIC,KAC7BE,KAAMN,eAAeO,WACrBC,UAAU,EACVhD,UAAWuC,MAAMU,QAAUV,MAAMU,QAAQjD,eAAYkD,IAEhDnD,aAVLD,cAAcC,OAAQwC,MAAMU,QAAQjD,WAN7BD,QAiBR,CAACgB,OAAQK,oBAEZG,MAAMK,UAAU,KACd,MAAM7B,OAASuB,UAAUK,QACzB,IAAKL,YAAcP,OACjB,OAEF,MAAM8B,SAAWd,UAAUoB,IAAIC,MAAO,UAASrC,OAAO8B,UAChDQ,MACJtB,UAAUhC,OAAO0C,SAASI,WAAad,UAAUhC,OAAOuD,YAAYvC,OAAO+B,KAAM,aAAcD,UAI7FQ,MAAMN,aAAehC,OAAO+B,MAC9BO,MAAME,SAASxC,OAAO+B,MAGxB/C,OAAOyD,SAASH,OAChBvD,cAAcC,OAAQgB,OAAOf,YAC5B,CAACe,SAEJ,MAAMkC,QAAU1B,MAAMkC,QAAQ,KACrB,CACLC,SAAU,KACVC,QAAS,CACPC,SAAS,GAEXZ,SAAUjC,kBAAF,EAAEA,OAAQiC,WAEnB,CAACjC,SAEE8C,UAAYtC,MAAMe,YAAawB,SACnC,IAAK/C,OACH,OAEF+C,OAAO/D,OAAOgE,YArIM,YAqIuBC,mBAG3CF,OAAO9B,UAAUC,WAAWC,mBAAmB+B,mBAAkB,GACjEH,OAAO9B,UAAUC,WAAWiC,mBAAmBD,mBAAkB,GAEjEH,OAAO9B,UAAUmC,uCAAuC,aAAc,CACpEC,+BAAgCC,cAC9B,IACE,MAAO,CACL,CACEC,MAAOjB,MAAMkB,oBACbC,WAAY,qBAAkBnB,MAAMN,cAGxC,MAAO0B,GACP,MAAO,QAMT,iCACFX,OAAO9B,UAAUC,WAAWC,mBAAmBwC,sBAAsB,CACnEC,oBAAoB,EACpBC,sBAAsB,IAW1BhE,cAAciE,aAAaC,QAASC,KAClCjB,OAAO9B,UAAUC,WAAWC,mBAAmBC,YAC7C4C,IAAIC,WACH,+BAA8BD,IAAI3C,WAGvCxB,cAAcqE,aAAaH,QAASI,aAClC,MAAMrC,SAAWd,UAAUoB,IAAIC,MAAO,UAAS8B,WAAWrC,WAExDiB,OAAO/D,OAAO0C,SAASI,WAAaiB,OAAO/D,OAAOuD,YAAY4B,WAAWF,WAAY,aAAcnC,WAC/FsC,cAAc,CAAEC,QAAS,MAGjC,MAAMvC,SAAWd,UAAUoB,IAAIC,MAAO,UAASrC,OAAO8B,UAChDQ,MAAQS,OAAO/D,OAAO0C,SAASI,WAAaiB,OAAO/D,OAAOuD,YAAYvC,OAAO+B,KAAM,aAAcD,UAIvG,OADAQ,MAAM8B,cAAc,CAAEC,QAAS,IACxB,CACL/B,cAED,CAACtC,SAEEsE,SAAW9D,MAAMe,YAAY+B,UACjC,MAAMhB,MAAQ/B,UAAUK,SAAWL,UAAUK,QAAQc,WACjDY,OAAStC,SAAWA,OAAOiC,WAEzBtB,oBAAoBC,eAChBL,UAAUK,QAAQ2D,UAAU,gCAAgCC,MAEpEpE,KAAKkC,MAAMN,cAEZ,CAAC5B,KAAMJ,SAEJyE,SAAWjE,MAAMe,YAAavC,SAClCuB,UAAUK,QAAU5B,OAChBkB,UACFQ,WAAWE,SAAU,aAAAE,aAAYP,UAAUK,UAE7C5B,OAAO0F,UAAU,CACfC,GAAI,SACJC,MAAO,oBACPC,YAAa,CAAC7D,UAAU8D,OAAOC,QAAU/D,UAAUgE,QAAQC,OAC3DT,IAAKF,YAEN,CAACpE,QAASoE,WAEPY,SAAW1E,MAAMe,YAAa4D,SAAoBlF,cAAckF,SAAU,CAAClF,gBAEjF,OAAKD,OAMH,oBAAC,2BAAD,CACEoF,IAAKjF,UACLkF,SAAS,aACTC,MAnOkB,YAoOlBC,gBAAiBzC,UACjB0C,eAAgBf,SAChBvC,QAASA,QACTgD,SAAUA,WAXL,M,oLCtOX5B,eAAiCvB,MAC/B,IAAI0D,SAAUC,aAWd,OAJED,eAAiB,uEACjBC,mBAAqB,uEAGhBD,SAASE,OAAO5D,KAAM,CAAE6D,OAAQ,aAAcC,QAAS,CAACH,iB","file":"node-playground-editor.js","sourcesContent":["// @flow\n//\n//  Copyright (c) 2019-present, Cruise LLC\n//\n//  This source code is licensed under the Apache License, Version 2.0,\n//  found in the LICENSE file in the root directory of this source tree.\n//  You may not use this file except in compliance with the License.\n\nimport * as monacoApi from \"monaco-editor/esm/vs/editor/editor.api\";\nimport { StaticServices } from \"monaco-editor/esm/vs/editor/standalone/browser/standaloneServices\";\nimport { initVimMode } from \"monaco-vim\";\nimport * as React from \"react\";\nimport MonacoEditor from \"react-monaco-editor\";\n\nimport getPrettifiedCode from \"webviz-core/src/panels/NodePlayground/prettier\";\nimport type { Script, EditorSelection } from \"webviz-core/src/panels/NodePlayground/script\";\nimport vsWebvizTheme from \"webviz-core/src/panels/NodePlayground/theme/vs-webviz.json\";\nimport { getNodeProjectConfig } from \"webviz-core/src/players/UserNodePlayer/nodeTransformerWorker/typescript/projectConfig\";\nimport inScreenshotTests from \"webviz-core/src/stories/inScreenshotTests\";\n\nconst VS_WEBVIZ_THEME = \"vs-webviz\";\n\nconst codeEditorService = StaticServices.codeEditorService.get();\n\ntype Props = {|\n  script: Script | null,\n  setScriptCode: (code: string) => void,\n  vimMode: boolean,\n  autoFormatOnSave: boolean,\n  rosLib: string,\n  /* A minor hack to tell the monaco editor to resize when dimensions change. */\n  resizeKey: string,\n  save: (code: string) => void,\n  setScriptOverride: (script: Script) => void,\n|};\n\n// Taken from:\n// https://github.com/microsoft/vscode/blob/master/src/vs/editor/standalone/browser/standaloneCodeServiceImpl.ts\nconst gotoSelection = (editor: monacoApi.Editor, selection?: EditorSelection) => {\n  if (selection) {\n    if (selection.endLineNumber && selection.endColumn) {\n      // These fields indicate a range was selected, set the range and reveal it.\n      editor.setSelection(selection);\n      editor.revealRangeInCenter(selection, 1 /* Immediate */);\n    } else {\n      // Otherwise it's just a position\n      const pos = {\n        lineNumber: selection.startLineNumber,\n        column: selection.startColumn,\n      };\n      editor.setPosition(pos);\n      editor.revealPositionInCenter(pos, 1 /* Immediate */);\n    }\n  }\n};\n\nconst projectConfig = getNodeProjectConfig();\nconst Editor = ({\n  autoFormatOnSave,\n  script,\n  setScriptCode,\n  vimMode,\n  resizeKey,\n  save,\n  setScriptOverride,\n  rosLib,\n}: Props) => {\n  const editorRef = React.useRef<monacoApi.Editor>(null);\n  const vimModeRef = React.useRef(null);\n  const autoFormatOnSaveRef = React.useRef(autoFormatOnSave);\n  autoFormatOnSaveRef.current = autoFormatOnSave;\n\n  React.useEffect(() => {\n    if (editorRef.current) {\n      if (vimMode) {\n        vimModeRef.current = initVimMode(editorRef.current);\n      } else if (vimModeRef.current) {\n        // Turn off VimMode.\n        vimModeRef.current.dispose();\n      }\n    }\n  }, [vimMode]);\n\n  React.useEffect(() => {\n    monacoApi.languages.typescript.typescriptDefaults.addExtraLib(\n      rosLib,\n      `file:///node_modules/@types/${projectConfig.rosLib.fileName}`\n    );\n  }, [rosLib]);\n\n  /*\n  In order to support go-to across files we override the code editor service doOpenEditor method.\n  Default implementation checks if the requested resource is the current model and no ops if it isn't.\n  Our implementation looks across all of our models to find the one requested and then queues that as\n  an override along with the requested selection (containing line # etc). When we're told to load\n  this override script we'll end up loading the model in the useEffect below, and then using this\n  selection to move to the correct line.\n  */\n  codeEditorService.doOpenEditor = React.useCallback((editor, input) => {\n    const requestedModel = monacoApi.editor.getModel(input.resource);\n    if (!requestedModel) {\n      return editor;\n    }\n\n    // If we are jumping to a definition within the user node, don't push\n    // to script override.\n    if (requestedModel.uri.path === script?.filePath) {\n      gotoSelection(editor, input.options.selection);\n      return;\n    }\n\n    setScriptOverride({\n      filePath: requestedModel.uri.path,\n      code: requestedModel.getValue(),\n      readOnly: true,\n      selection: input.options ? input.options.selection : undefined,\n    });\n    return editor;\n  }, [script, setScriptOverride]);\n\n  React.useEffect(() => {\n    const editor = editorRef.current;\n    if (!editorRef || !script) {\n      return;\n    }\n    const filePath = monacoApi.Uri.parse(`file://${script.filePath}`);\n    const model =\n      monacoApi.editor.getModel(filePath) || monacoApi.editor.createModel(script.code, \"typescript\", filePath);\n\n    // Update the model's code if it was updated outside the Editor.\n    // Without this, monaco can continue to show old code if the userScripts are changed outside of the Editor\n    if (model.getValue() !== script.code) {\n      model.setValue(script.code);\n    }\n\n    editor.setModel(model);\n    gotoSelection(editor, script.selection);\n  }, [script]);\n\n  const options = React.useMemo(() => {\n    return {\n      wordWrap: \"on\",\n      minimap: {\n        enabled: false,\n      },\n      readOnly: script?.readOnly,\n    };\n  }, [script]);\n\n  const willMount = React.useCallback((monaco) => {\n    if (!script) {\n      return;\n    }\n    monaco.editor.defineTheme(VS_WEBVIZ_THEME, vsWebvizTheme);\n\n    // Set eager model sync to enable intellisense between the user code and utility files\n    monaco.languages.typescript.typescriptDefaults.setEagerModelSync(true);\n    monaco.languages.typescript.javascriptDefaults.setEagerModelSync(true);\n\n    monaco.languages.registerDocumentFormattingEditProvider(\"typescript\", {\n      provideDocumentFormattingEdits: async (model) => {\n        try {\n          return [\n            {\n              range: model.getFullModelRange(),\n              text: await getPrettifiedCode(model.getValue()),\n            },\n          ];\n        } catch (e) {\n          return [];\n        }\n      },\n    });\n\n    // Disable validation in screenshots to avoid flaky tests\n    if (inScreenshotTests()) {\n      monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({\n        noSyntaxValidation: true,\n        noSemanticValidation: true,\n      });\n    }\n\n    // Load declarations and additional utility files from project config\n\n    // This ensures the type defs we enforce in\n    // the 'compile' step match that of monaco. Adding the 'lib'\n    // this way (instead of specifying it in the compiler options)\n    // is a hack to overwrite the default type defs since the\n    // typescript language service does not expose such a method.\n    projectConfig.declarations.forEach((lib) =>\n      monaco.languages.typescript.typescriptDefaults.addExtraLib(\n        lib.sourceCode,\n        `file:///node_modules/@types/${lib.fileName}`\n      )\n    );\n    projectConfig.utilityFiles.forEach((sourceFile) => {\n      const filePath = monacoApi.Uri.parse(`file://${sourceFile.filePath}`);\n      const model =\n        monaco.editor.getModel(filePath) || monaco.editor.createModel(sourceFile.sourceCode, \"typescript\", filePath);\n      model.updateOptions({ tabSize: 2 });\n    });\n\n    const filePath = monacoApi.Uri.parse(`file://${script.filePath}`);\n    const model = monaco.editor.getModel(filePath) || monaco.editor.createModel(script.code, \"typescript\", filePath);\n\n    // Because anything else is blasphemy.\n    model.updateOptions({ tabSize: 2 });\n    return {\n      model,\n    };\n  }, [script]);\n\n  const saveCode = React.useCallback(async () => {\n    const model = editorRef.current && editorRef.current.getModel();\n    if (model && script && !script.readOnly) {\n      // We have to use a ref for autoFormatOnSaveRef because of how monaco scopes the action callbacks\n      if (autoFormatOnSaveRef.current) {\n        await editorRef.current.getAction(\"editor.action.formatDocument\").run();\n      }\n      save(model.getValue());\n    }\n  }, [save, script]);\n\n  const didMount = React.useCallback((editor) => {\n    editorRef.current = editor;\n    if (vimMode) {\n      vimModeRef.current = initVimMode(editorRef.current);\n    }\n    editor.addAction({\n      id: \"ctrl-s\",\n      label: \"Save current node\",\n      keybindings: [monacoApi.KeyMod.CtrlCmd | monacoApi.KeyCode.KEY_S],\n      run: saveCode,\n    });\n  }, [vimMode, saveCode]);\n\n  const onChange = React.useCallback((srcCode: string) => setScriptCode(srcCode), [setScriptCode]);\n\n  if (!script) {\n    // No script to load\n    return null;\n  }\n\n  return (\n    <MonacoEditor\n      key={resizeKey}\n      language=\"typescript\"\n      theme={VS_WEBVIZ_THEME}\n      editorWillMount={willMount}\n      editorDidMount={didMount}\n      options={options}\n      onChange={onChange}\n    />\n  );\n};\n\nexport default Editor;\n","// @flow\n//\n//  Copyright (c) 2020-present, Cruise LLC\n//\n//  This source code is licensed under the Apache License, Version 2.0,\n//  found in the LICENSE file in the root directory of this source tree.\n//  You may not use this file except in compliance with the License.\n\n// Takes in a string of Typescript code and returns\n// beautified, formatted string of Typescript code\nasync function getPrettifiedCode(code: string): Promise<string> {\n  let prettier, parserPlugin;\n\n  // Dynamic imports don't work in node-based jest tests, so require() them instead\n  if (process.env.NODE_ENV === \"test\") {\n    prettier = require(\"prettier/standalone\");\n    parserPlugin = require(\"prettier/parser-typescript\");\n  } else {\n    prettier = await import(/* webpackChunkName: \"prettier\" */ \"prettier/standalone\");\n    parserPlugin = await import(/* webpackChunkName: \"prettier\" */ \"prettier/parser-typescript\");\n  }\n\n  return prettier.format(code, { parser: \"typescript\", plugins: [parserPlugin] });\n}\n\nexport default getPrettifiedCode;\n"],"sourceRoot":""}